---
title: "How to create an http proxy in next.js?"
publishedAt: "2021-6"
image: "/images/blog/http-proxy.jpg"
readingTime: "10"
category: "next.js"
summary: "How to create an http proxy middleware with help of serverless functions in next.js?"
---

With next.js introducing api routes and serverless functions, a lot of ideas becomes possible for front-end developers.

Some of the benefits are

- No need to handle CORS policy because we are making API request from one server to another server.
- Conntecting directly to databases.
- Creating RESTful APIs without needing to any backend server.
- Implementing middlewares and proxies
- ...

You can read more about this concepts in [next.js documentaion](https://vercel.com/docs/concepts/functions/serverless-functions).

A way of using them is with writing http proxies to add proxies as an extra client-server transport layer.

## Why?

There are so many interesting things that comes with using proxies, for example you can save authorization token as an http-only cookie and pass every api through the http proxy to add token to header. This way accessing token is a lot harder for malicious users (not impossible ofcourse).
Other usefull things you can do are: `hiding the IP address`, `filtering requests`, `protection and security`, `caching` and ...

## How?

So how to create an http proxy with next.js serverless functions?
It's so simple,
First you need two packages, [cookies](https://www.npmjs.com/package/cookies) and [http-proxy](https://www.npmjs.com/package/http-proxy).

```js
import * as HttpProxy from "http-proxy";
import url from "url";
import { INTERVALS, TOKEN_COOKIE_KEY } from "@constants";
import {
  externalApiBaseURL,
  headerTokenKey,
  proxyBasePath,
  proxyBasePathRegExp,
} from "@config";
import * as Cookies from "cookies";
const proxy = HttpProxy.createProxyServer();
export const config = {
  api: {
    bodyParser: false,
  },
};
export default (req, res) => {
  return new Promise((resolve, reject) => {
    const pathname = url.parse(req.url).pathname;
    const isAuth = pathname === proxyBasePath + "/auth/login";
    // const isLogout = pathname === proxyBasePath + "/auth/logout";
    const cookies = new Cookies(req, res);
    const token = cookies.get(TOKEN_COOKIE_KEY);
    req.url = req.url.replace(proxyBasePathRegExp, "");
    req.headers.cookie = "";
    if (token) req.headers[headerTokenKey] = token;
    if (isAuth) proxy.once("proxyRes", interceptLoginResponse);
    //  if (isLogout) { delete the token cookie }
    proxy.once("error", reject);
    proxy.web(req, res, {
      target: externalApiBaseURL,
      autoRewrite: false,
      selfHandleResponse: isAuth,
    });
    function interceptLoginResponse(proxyRes, req, res) {
      let apiResponseBody = "";
      proxyRes.on("data", (chunk) => {
        apiResponseBody += chunk;
      });
      proxyRes.on("end", () => {
        try {
          const response = JSON.parse(apiResponseBody);
          const token = response?.result?.token;
          const cookies = new Cookies(req, res);
          cookies.set(TOKEN_COOKIE_KEY, token, {
            maxAge: INTERVALS.A_MONTH * 1000,
            httpOnly: true,
            sameSite: "lax",
          });
          delete response?.result?.token;
          res.status(200).json(response);
          resolve(response);
        } catch (err) {
          reject(err);
        }
      });
    }
  });
};
```
